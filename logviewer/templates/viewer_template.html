<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Log Viewer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 0; margin: 0; background: #f9f9f9; }
    .log-entry { border: 1px solid #ddd; margin: 5px 0; padding: 10px; border-radius: 6px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .log-entry .details { display: none; margin-top: 8px; font-size: 0.9em; color: #444; }
    .log-entry.expanded .details { display: block; }
    .severity-LOG_ERR { background-color: #ffe5e5; border-left: 5px solid #dc3545; }
    .severity-LOG_WARN { background-color: #fff8e1; border-left: 5px solid #ffc107; }
    .severity-LOG_INFO { background-color: #e7f3fe; border-left: 5px solid #17a2b8; }
    .severity-UNKNOWN { background-color: #f0f0f0; border-left: 5px solid #999; }
    pre { white-space: pre-wrap; word-wrap: break-word; }
    .panel-controls { margin-bottom: 1rem; }
    #isp-modal { display:none; position:fixed; top:10%; left:10%; width:80%; height:80%; background:#fff; border:2px solid #444; padding:20px; overflow:auto; z-index:1000 }
  </style>
</head>
<body class="container-fluid py-3">
  <h2 class="mb-4">Log Viewer</h2>

  <div class="panel-controls">
    <label for="process-filter">Process:</label>
    <select id="process-filter" class="form-select d-inline w-auto"><option value="">-- All --</option></select>
    <input type="text" id="keyword" class="form-control d-inline w-auto" placeholder="Search messages">
    <input type="datetime-local" id="from" class="form-control d-inline w-auto">
    <input type="datetime-local" id="to" class="form-control d-inline w-auto">
    <label class="form-check-label ms-2"><input type="checkbox" id="include-fastlogs" checked> Include Fastlogs</label>
    <button class="btn btn-primary ms-2" onclick="applyFilters()">Apply</button>
    <button class="btn btn-secondary ms-1" onclick="resetFilter()">Reset</button>
    <button class="btn btn-info ms-2" onclick="showISP()">View ISP Output</button>
  </div>

  <ul class="nav nav-tabs" id="logTab" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#logs">Logs</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fastlogs">Fastlogs</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#diag">Diag Dumps</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#showtech">ShowTech</button></li>
  </ul>

  <div class="tab-content mt-3">
    <div class="tab-pane fade show active" id="logs">
      <div id="log-container"></div>
      <div id="pagination-controls" class="mt-3">
        <button class="btn btn-sm btn-outline-secondary" onclick="prevPage()">Previous</button>
        <span id="page-info" class="mx-2">Page 1</span>
        <button class="btn btn-sm btn-outline-secondary" onclick="nextPage()">Next</button>
      </div>
    </div>
    <div class="tab-pane fade" id="fastlogs">
      <label for="fastlog-select">File:</label>
      <select id="fastlog-select" class="form-select w-auto d-inline"></select>
      <pre id="fastlog-content" class="mt-2"></pre>
    </div>
    <div class="tab-pane fade" id="diag">
      <label for="diag-select">File:</label>
      <select id="diag-select" class="form-select w-auto d-inline"></select>
      <pre id="diag-content" class="mt-2"></pre>
    </div>
    <div class="tab-pane fade" id="showtech">
      <select id="showtech-select" class="form-select w-auto my-2"></select>
      <pre id="showtech-content"></pre>
    </div>
  </div>

  <div id="isp-modal">
    <button onclick="closeISP()" class="btn btn-danger float-end">Close</button>
    <pre id="isp-content"></pre>
  </div>

<script>
function formatTimestamp(isoString) {
  try {
    const date = new Date(isoString);
    return date.toLocaleString(undefined, {
      year: 'numeric', month: 'short', day: 'numeric',
      hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
  } catch {
    return isoString;
  }
}

let logs = [], allLogs = [], filteredLogs = [], currentPage = 1;
const logsPerPage = 100;
const processSet = new Set();
const cacheBuster = '?v=' + new Date().getTime();

fetch('parsed_logs.json' + cacheBuster)
  .then(res => res.json())
  .then(data => {
    logs = data;
    allLogs = data;
    filteredLogs = data;
    logs.forEach(log => processSet.add(log.process));
    const filter = document.getElementById("process-filter");
    [...processSet].sort().forEach(proc => {
      const opt = document.createElement("option");
      opt.value = proc;
      opt.textContent = proc;
      filter.appendChild(opt);
    });
    renderLogs(filteredLogs);
  });

function renderLogs(entries) {
  const container = document.getElementById("log-container");
  const start = (currentPage - 1) * logsPerPage;
  const end = currentPage * logsPerPage;
  const pageLogs = entries.slice(start, end);
  container.innerHTML = '';
  pageLogs.forEach(log => {
    const div = document.createElement("div");
    div.className = "log-entry severity-" + (log.severity || 'UNKNOWN');
    div.innerHTML = "<strong>" + formatTimestamp(log.timestamp) + "</strong> | <em>" + log.process + "</em> | " + log.message +
                    "<div class='details'><pre>" + JSON.stringify(log, null, 2) + "</pre></div>";
    div.addEventListener("click", () => div.classList.toggle("expanded"));
    container.appendChild(div);
  });
  document.getElementById("page-info").textContent = "Page " + currentPage + " of " + Math.ceil(entries.length / logsPerPage);
}

function applyFilters() {
  const proc = document.getElementById("process-filter").value;
  const keyword = document.getElementById("keyword").value.toLowerCase();
  const from = new Date(document.getElementById("from").value);
  const to = new Date(document.getElementById("to").value);
  const includeFastlogs = document.getElementById("include-fastlogs").checked;
  filteredLogs = allLogs.filter(log => {
    const time = new Date(log.timestamp);
    const isFastlog = log.source === "fastlog" || (log.process || "").toLowerCase().includes("fastlog");
    return (!proc || log.process === proc) &&
           (!keyword || log.message.toLowerCase().includes(keyword)) &&
           (!isNaN(from) ? time >= from : true) &&
           (!isNaN(to) ? time <= to : true) &&
           (includeFastlogs || !isFastlog);
  });
  currentPage = 1;
  renderLogs(filteredLogs);
}

function resetFilter() {
  currentPage = 1;
  filteredLogs = allLogs;
  renderLogs(allLogs);
}

function nextPage() {
  const maxPage = Math.ceil(filteredLogs.length / logsPerPage);
  if (currentPage < maxPage) {
    currentPage++;
    renderLogs(filteredLogs);
  }
}

function prevPage() {
  if (currentPage > 1) {
    currentPage--;
    renderLogs(filteredLogs);
  }
}

fetch('fastlog_index.json' + cacheBuster).then(res => res.json()).then(files => {
  const select = document.getElementById("fastlog-select");
  files.forEach(file => {
    const opt = document.createElement("option");
    opt.value = file;
    opt.textContent = file;
    select.appendChild(opt);
  });
  select.addEventListener("change", () => {
    fetch('fastlogs/' + select.value + cacheBuster)
      .then(res => res.text())
      .then(content => {
        document.getElementById("fastlog-content").textContent = content;
      });
  });
  if (files.length > 0) {
    select.value = files[0];
    select.dispatchEvent(new Event("change"));
  }
});

fetch('diag_index.json' + cacheBuster).then(res => res.json()).then(files => {
  const select = document.getElementById("diag-select");
  files.forEach(file => {
    const opt = document.createElement("option");
    opt.value = file;
    opt.textContent = file;
    select.appendChild(opt);
  });
  select.addEventListener("change", () => {
    const flatName = select.value.replace(/\//g, '_');
    const filename = 'feature_' + flatName + '_diagdump.txt' + cacheBuster;
    fetch(filename)
      .then(res => res.text())
      .then(content => {
        document.getElementById("diag-content").textContent = content;
      });
  });
  if (files.length > 0) {
    select.value = files[0];
    select.dispatchEvent(new Event("change"));
  }
});

fetch('showtech_index.json' + cacheBuster).then(res => res.json()).then(files => {
  const select = document.getElementById("showtech-select");
  for (const [label, filename] of Object.entries(files)) {
    const opt = document.createElement("option");
    opt.value = filename;
    opt.textContent = label;
    select.appendChild(opt);
  }
  select.addEventListener("change", () => {
    fetch(select.value + cacheBuster)
      .then(res => res.text())
      .then(content => {
        document.getElementById("showtech-content").textContent = content;
      });
  });
  if (select.options.length > 0) {
    select.selectedIndex = 0;
    select.dispatchEvent(new Event("change"));
  }
});

function showISP() {
  fetch('isp.txt')
    .then(res => res.text())
    .then(content => {
      document.getElementById("isp-content").textContent = content;
      document.getElementById("isp-modal").style.display = 'block';
    });
}

function closeISP() {
  document.getElementById("isp-modal").style.display = 'none';
}
</script>
</body>
</html>

