<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title id="dynamic-title">Log Viewer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/rangePlugin.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 0;
      margin: 0;
      background: #f9f9f9;
    }
    .log-entry {
      border: 1px solid #ddd;
      margin: 5px 0;
      padding: 10px;
      border-radius: 6px;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .log-entry .details {
      display: none;
      margin-top: 8px;
      font-size: 0.9em;
      color: #444;
    }
    .log-entry.expanded .details {
      display: block;
    }
    .severity-LOG_ERR { background-color: #ffe5e5; border-left: 5px solid #dc3545; }
    .severity-LOG_WARN { background-color: #fff8e1; border-left: 5px solid #ffc107; }
    .severity-LOG_INFO { background-color: #e7f3fe; border-left: 5px solid #17a2b8; }
    .severity-UNKNOWN { background-color: #f0f0f0; border-left: 5px solid #999; }
    pre { white-space: pre-wrap; word-wrap: break-word; }
    .panel-controls { margin-bottom: 1rem; }
    #isp-modal { display:none; position:fixed; top:10%; left:10%; width:80%; height:80%; background:#fff; border:2px solid #444; padding:20px; overflow:auto; z-index:1000 }
    .help-button {
      position: fixed;
      top: 10px;
      right: 16px;
      background: #17a2b8;
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      z-index: 10001;
    }
    #help-modal {
      display: none;
      position: fixed;
      z-index: 9999;
      top: 10%;
      left: 10%;
      width: 80%;
      height: 80%;
      background: white;
      border: 2px solid #666;
      border-radius: 8px;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
    }
    #help-modal-close {
      position: absolute;
      top: 10px;
      right: 16px;
      font-size: 18px;
      font-weight: bold;
      color: #dc3545;
      cursor: pointer;
    }
  </style>
</head>
<body class="container-fluid py-3">
  <h2 class="mb-4">Log Viewer</h2>
  <button class="help-button" onclick="openHelp()">?</button>
  

  <div class="panel-controls d-flex flex-wrap align-items-center gap-2">
    <label for="process-filter">Process:</label>
    <select id="process-filter" class="form-select d-inline w-auto"><option value="">-- All --</option></select>
    <input type="text" id="keyword" class="form-control d-inline w-auto" placeholder="Search messages">
    
    <div class="d-inline align-middle" style="width: 300px; margin-left: 10px;" id="timestamp-slider"></div>
    <span class="d-inline align-middle" id="slider-range-label" style="margin-left: 10px; font-weight: bold;"></span>


    
    <label class="form-check-label ms-2"><input type="checkbox" id="include-fastlogs" checked> Include Fastlogs</label>
    <button class="btn btn-primary ms-2" onclick="applyFilters()">Apply</button>
    <button class="btn btn-secondary ms-1" onclick="resetFilter()">Reset</button>
    <button class="btn btn-success ms-1" onclick="exportFilteredLogs()">Export Logs</button>
    <button class="btn btn-info ms-2" onclick="showISP()">View ISP Output</button>
  </div>

  <ul class="nav nav-tabs" id="logTab" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#logs">Logs</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fastlogs">Fastlogs</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#diag">Diag Dumps</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#showtech">ShowTech</button></li>
  </ul>

  <div class="tab-content mt-3">
    <div class="tab-pane fade show active" id="logs">
      <div style="background: white; padding: 10px; border: 1px solid #ddd;">
        <canvas id="error-chart" style="width: 100%; height: 300px; margin-bottom: 20px;"></canvas>
      </div>
      <div id="log-container"></div>
      <div id="pagination-controls" class="mt-3">
        <button class="btn btn-sm btn-outline-secondary" onclick="prevPage()">Previous</button>
        <span id="page-info" class="mx-2">Page 1</span>
        <button class="btn btn-sm btn-outline-secondary" onclick="nextPage()">Next</button>
      </div>
    </div>
    <div class="tab-pane fade" id="fastlogs">
      <label for="fastlog-select">File:</label>
      <select id="fastlog-select" class="form-select w-auto d-inline"></select>
      <pre id="fastlog-content" class="mt-2"></pre>
    </div>
    <div class="tab-pane fade" id="diag">
      <label for="diag-select">File:</label>
      <select id="diag-select" class="form-select w-auto d-inline"></select>
      <pre id="diag-content" class="mt-2"></pre>
    </div>
    <div class="tab-pane fade" id="showtech">
      <select id="showtech-select" class="form-select w-auto my-2"></select>
      <pre id="showtech-content"></pre>
    </div>
  </div>

  <div id="isp-modal">
    <button onclick="closeISP()" class="btn btn-danger float-end">Close</button>
    <pre id="isp-content"></pre>
  </div>

  <div id="help-modal">
    <span id="help-modal-close" onclick="closeHelp()">&times;</span>
    <div id="help-content"><em>Loading README.md...</em></div>
  </div>

<script>
  // If running inside an iframe, hide the help button
  if (window !== window.parent) {
    document.addEventListener("DOMContentLoaded", () => {
      const helpBtn = document.querySelector(".help-button");
      if (helpBtn) helpBtn.style.display = "none";
    });
  }

let selectedFrom = null;
let selectedTo = null;

function initTimestampSlider(minDate, maxDate) {
  const slider = document.getElementById('timestamp-slider');
  noUiSlider.create(slider, {
    start: [minDate.getTime(), maxDate.getTime()],
    connect: true,
    range: {
      min: minDate.getTime(),
      max: maxDate.getTime()
    },
    step: 60 * 1000, // 1 minute steps
    tooltips: false,
    format: {
      to: value => Number(value),     // strictly return number
      from: value => Number(value)    // strictly parse number
    }
  });

  slider.noUiSlider.on('update', function (values) {
    try {
      // Force both to be numbers
      const from = Number(values[0]);
      const to = Number(values[1]);

      if (isNaN(from) || isNaN(to)) {
        console.error("Slider values not valid numbers:", values);
        return;
      }

      selectedFrom = new Date(from);
      selectedTo = new Date(to);

      document.getElementById("slider-range-label").textContent =
        `${selectedFrom.toISOString().slice(0, 16).replace('T', ' ')} â†’ ${selectedTo.toISOString().slice(0, 16).replace('T', ' ')}`;
    } catch (e) {
      console.error(" Failed to parse slider values:", values, e);
    }
  });
}
  
function openHelp() {
  fetch("README.md")
    .then(res => res.text())
    .then(md => {
      document.getElementById("help-content").innerHTML = marked.parse(md);
      document.getElementById("help-modal").style.display = "block";
    })
    .catch(() => {
      document.getElementById("help-content").innerText = "README.md not found.";
    });
}
function closeHelp() {
  document.getElementById("help-modal").style.display = "none";
}

function formatTimestamp(isoString) {
  try {
    const date = new Date(isoString);
    return date.toLocaleString(undefined, {
      year: 'numeric', month: 'short', day: 'numeric',
      hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
  } catch {
    return isoString;
  }
}

let logs = [], allLogs = [], filteredLogs = [], currentPage = 1;
const logsPerPage = 100;
const processSet = new Set();
const cacheBuster = '?v=' + new Date().getTime();

fetch('parsed_logs.json' + cacheBuster)
  .then(res => res.json())
  .then(data => {
    logs = data;
    allLogs = data;
    filteredLogs = data;
    logs.forEach(log => processSet.add(log.process));
    const filter = document.getElementById("process-filter");
    [...processSet].sort().forEach(proc => {
      const opt = document.createElement("option");
      opt.value = proc;
      opt.textContent = proc;
      filter.appendChild(opt);
    });
    renderLogs(filteredLogs);
    updateErrorChart(filteredLogs); 
    
    const timestamps = logs.map(l => new Date(l.timestamp)).filter(d => !isNaN(d));
    const min = new Date(Math.min(...timestamps));
    const max = new Date(Math.max(...timestamps));
    initTimestampSlider(min, max);
    
  });

  
function buildErrorTimeline(entries) {
  
  const errorCounts = {};
  entries.forEach(log => {
    if (log.severity === 'LOG_ERR') {
      const hour = new Date(log.timestamp).toISOString().slice(0, 13); // e.g., "2025-05-22T14"
      errorCounts[hour] = (errorCounts[hour] || 0) + 1;
    }
  });

  const sortedKeys = Object.keys(errorCounts).sort();
  const labels = sortedKeys.map(k => k.replace('T', ' '));
  const data = sortedKeys.map(k => errorCounts[k]);

  console.log("Found error timestamps:", labels, data);
  console.log("ðŸ“Š Chart labels:", labels);
  console.log("ðŸ“ˆ Chart data:", data);
  return { labels, data };
}

function renderLogs(entries) {
  const container = document.getElementById("log-container");
  const start = (currentPage - 1) * logsPerPage;
  const end = currentPage * logsPerPage;
  const pageLogs = entries.slice(start, end);
  container.innerHTML = '';
  pageLogs.forEach(log => {
    const div = document.createElement("div");
    div.className = "log-entry severity-" + (log.severity || 'UNKNOWN');
    div.innerHTML = "<strong>" + formatTimestamp(log.timestamp) + "</strong> | <em>" + log.process + "</em> | " + log.message +
                    "<div class='details'><pre>" + JSON.stringify(log, null, 2) + "</pre></div>";
    div.addEventListener("click", () => div.classList.toggle("expanded"));
    container.appendChild(div);
  });
  document.getElementById("page-info").textContent = "Page " + currentPage + " of " + Math.ceil(entries.length / logsPerPage);
}

function applyFilters() {
  const proc = document.getElementById("process-filter").value;
  const keyword = document.getElementById("keyword").value.toLowerCase();
  
  const includeFastlogs = document.getElementById("include-fastlogs").checked;

  const from = selectedFrom;
  const to = selectedTo;
  const validFrom = from instanceof Date && !isNaN(from);
  const validTo = to instanceof Date && !isNaN(to);

  filteredLogs = allLogs.filter(log => {
    const time = new Date(log.timestamp);
    const isFastlog = log.source === "fastlog" || (log.process || "").toLowerCase().includes("fastlog");

    return (!proc || log.process === proc) &&
           (!keyword || log.message.toLowerCase().includes(keyword)) &&
           (!validFrom || time >= from) &&
           (!validTo || time <= to) &&
           (includeFastlogs || !isFastlog);
  });

  currentPage = 1;
  renderLogs(filteredLogs);
  updateErrorChart(filteredLogs);
}

function resetFilter() {
  document.getElementById("process-filter").value = "";
  document.getElementById("keyword").value = "";
  
  document.getElementById("include-fastlogs").checked = true;

  currentPage = 1;
  filteredLogs = allLogs;
  renderLogs(filteredLogs);
  updateErrorChart(filteredLogs);
}

function nextPage() {
  const maxPage = Math.ceil(filteredLogs.length / logsPerPage);
  if (currentPage < maxPage) {
    currentPage++;
    renderLogs(filteredLogs);
  }
}

function prevPage() {
  if (currentPage > 1) {
    currentPage--;
    renderLogs(filteredLogs);
  }
}

fetch('fastlog_index.json' + cacheBuster).then(res => res.json()).then(files => {
  const select = document.getElementById("fastlog-select");
  files.forEach(file => {
    const opt = document.createElement("option");
    opt.value = file;
    opt.textContent = file;
    select.appendChild(opt);
  });
  select.addEventListener("change", () => {
     fetch('fastlogs/' + select.value + cacheBuster)
      .then(res => res.text())
      .then(content => {
        document.getElementById("fastlog-content").textContent = content;
      });
  });
  if (files.length > 0) {
    select.value = files[0];
    select.dispatchEvent(new Event("change"));
  }
});

fetch('diag_index.json' + cacheBuster).then(res => res.json()).then(files => {
  const select = document.getElementById("diag-select");
  files.forEach(file => {
    const opt = document.createElement("option");
    opt.value = file;
    opt.textContent = file;
    select.appendChild(opt);
  });
  select.addEventListener("change", () => {
    const file = 'feature/' + select.value.replace(/\//g, '_') + '_diagdump.txt' + cacheBuster;
    fetch(file)
      .then(res => res.text())
      .then(content => {
        document.getElementById("diag-content").textContent = content;
      });
  });
  if (files.length > 0) {
    select.value = files[0];
    select.dispatchEvent(new Event("change"));
  }
});

fetch('showtech_index.json' + cacheBuster).then(res => res.json()).then(files => {
  const select = document.getElementById("showtech-select");
  for (const [label, filename] of Object.entries(files)) {
    const opt = document.createElement("option");
    opt.value = filename;
    opt.textContent = label;
    select.appendChild(opt);
  }
  select.addEventListener("change", () => {
    fetch(select.value + cacheBuster)
      .then(res => res.text())
      .then(content => {
        document.getElementById("showtech-content").textContent = content;
      });
  });
  if (select.options.length > 0) {
    select.selectedIndex = 0;
    select.dispatchEvent(new Event("change"));
  }
});

function showISP() {
  fetch('isp.txt')
    .then(res => res.text())
    .then(content => {
      document.getElementById("isp-content").textContent = content;
      document.getElementById("isp-modal").style.display = 'block';
    });
}

function closeISP() {
  document.getElementById("isp-modal").style.display = 'none';
}
  
function exportFilteredLogs() {
  if (!filteredLogs || filteredLogs.length === 0) {
    alert("No logs to export.");
    return;
  }

  const content = filteredLogs.map(log => {
    return `${formatTimestamp(log.timestamp)} | ${log.process} | ${log.message}`;
  }).join("\n");

  const blob = new Blob([content], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "filtered_logs.txt";
  a.click();
  URL.revokeObjectURL(url);
}

let errorChart = null;
function updateErrorChart(logs) {
  const ctx = document.getElementById("error-chart").getContext("2d");
  const { labels, data } = buildErrorTimeline(logs);

  if (errorChart) {
    errorChart.data.labels = labels;
    errorChart.data.datasets[0].data = data;
    errorChart.update();
  } else {
    errorChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Errors per Hour',
          data: data,
          borderColor: 'rgba(220,53,69,0.8)',
          backgroundColor: 'rgba(220,53,69,0.2)',
          fill: true,
          tension: 0.3,
          pointRadius: 3,
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true }
        },
        scales: {
          x: { title: { display: true, text: "Time (UTC Hour)" } },
          y: { title: { display: true, text: "Error Count" }, beginAtZero: true }
        }
      }
    });
  }
}
  
</script>
</body>
</html>

